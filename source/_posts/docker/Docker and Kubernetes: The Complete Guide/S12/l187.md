---
title: Onwards to Kubernetes
date: 2023-07-22 18:57:41
categories: ["Docker"]
tags: ["kubernetes","command"]




---

# å¼€å§‹ä½¿ç”¨Kubernetes

## 1. å®‰è£…ç¯å¢ƒ
è¿™é‡Œåœ¨`Ubuntu`è™šæ‹Ÿæœºä¸­ä½¿ç”¨`Minikube`ä½œä¸ºå®éªŒç¯å¢ƒ

### 1.1 æŒ‰ç…§Minikube
å‚è€ƒ[minikube start](https://minikube.sigs.k8s.io/docs/start/)  

### 1.2 å®‰è£…kubectl

è€ƒè™‘ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒ:  
```bash
curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -
echo "deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt-get update
sudo apt-get install -y  kubectl
```

### 1.3 å®‰è£…é—®é¢˜
1. StartHost: create: bootstrapping certificates: Failed to decode PEM dataï¼Œå¦‚æœé‡åˆ°è¯ä¹¦é”™è¯¯ï¼Œå¯ä»¥åˆ é™¤

## 2. éƒ¨ç½²ä¸€ä¸ªPodå’Œä¸€ä¸ªService

### 2.1 å¯åŠ¨Minikube
```bash
hwxy@myubuntu:~/k8s/simplek8s$ minikube start

ğŸ˜„  minikube v1.30.1 on Ubuntu 22.04 (arm64)
âœ¨  Using the docker driver based on existing profile
ğŸ‘  Starting control plane node minikube in cluster minikube
ğŸšœ  Pulling base image ...
ğŸ”„  Restarting existing docker container for "minikube" ...
ğŸ³  Preparing Kubernetes v1.26.3 on Docker 23.0.2 ...
ğŸ”—  Configuring bridge CNI (Container Networking Interface) ...
ğŸ”  Verifying Kubernetes components...
    â–ª Using image gcr.io/k8s-minikube/storage-provisioner:v5
ğŸŒŸ  Enabled addons: default-storageclass, storage-provisioner
ğŸ„  Done! kubectl is now configured to use "minikube" cluster and "default" namespace by default
```

### 2.2 å¯åŠ¨é—®é¢˜
1. StartHost: create: bootstrapping certificates: Failed to decode PEM data
å¦‚æœé‡åˆ°è¯ä¹¦é”™è¯¯ï¼Œå‚è€ƒ[https://github.com/kubernetes/minikube/issues/5293](https://github.com/kubernetes/minikube/issues/5293)

```bash
minikube delete
rm -Rf ~/.minikube/certs
```

### 2.3 éƒ¨ç½²Pod
å®¹å™¨è¿è¡Œåœ¨podå½“ä¸­ï¼Œä¸€ä¸ªpodå¯ä»¥æœ‰å¤šä¸ªå®¹å™¨ï¼Œè¿™é‡Œåªè¿è¡Œä¸€ä¸ªpod:  
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: client-pod
  labels:
    component: web
spec:
  containers:
    - name: client
      # é•œåƒå¯ä»¥æ¢æˆä½ ä¹‹å‰è¯¾ç¨‹ç»ƒä¹ ä½¿ç”¨çš„é•œåƒ
      image: hwxy233/multi-client
      ports:
        - containerPort: 3000

```
ç®€å•æ¥è¯´ï¼Œè¿™é‡Œ`kind`ä¸º`Pod`ï¼Œ`spec`å®šä¹‰äº†å°†è¿è¡Œä¸€ä¸ªå®¹å™¨ï¼Œè€Œå®¹å™¨ä½¿ç”¨çš„é•œåƒæ˜¯`hwxy233/multi-client` (é»˜è®¤ä»docker.ioæ‹‰å–)ï¼Œå®¹å™¨å°†æš´éœ²ä¸€ä¸ª3000ç«¯å£ï¼Œè€Œè¯¥é•œåƒä¸­nginxç›‘å¬çš„å°±æ˜¯3000ç«¯å£ã€‚  
å…·ä½“å‚è€ƒ: [https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/pod-v1/](https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/pod-v1/)

éƒ¨ç½²å’ŒæŸ¥çœ‹éƒ¨ç½²ç»“æœ:  
```bash
hwxy@myubuntu:~/k8s/simplek8s$ kubectl apply -f client-pod.yaml
pod/client-pod created
hwxy@myubuntu:~/k8s/simplek8s$ kubectl get pods --watch
NAME         READY   STATUS    RESTARTS   AGE
client-pod   1/1     Running   0          8s
```

### 2.4 éƒ¨ç½²Podé—®é¢˜
1. å¦‚æœé‡åˆ°STATUSæ˜¯ErrPullingImageï¼Œå¹¶ä¸”ä½ çš„ç”µè„‘æ˜¯m1èŠ¯ç‰‡çš„mac  
è¯·æ£€æŸ¥é•œåƒæ˜¯å¦æ”¯æŒ`arm64`ï¼Œå…·ä½“åœ¨æ„å»ºæ—¶å¯ä»¥å¢åŠ `platform`æ¥é¿å…æ‹‰å–é•œåƒå¤±è´¥ã€‚  
æ¯”å¦‚æˆ‘é€šè¿‡`github actions`è¿›è¡Œæ„å»ºå¯ä»¥ç¨ä½œä¿®æ”¹:  
```yaml
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      -
        name: Checkout
        uses: actions/checkout@v3
      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      -
        name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      -
        name: Build and push multi-client
        uses: docker/build-push-action@v4
        with:
          context: ./client
          # multi platform
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.IMAGE_NAME_MUTLTI_CLIENT }}:latest
            ${{ env.IMAGE_NAME_MUTLTI_CLIENT }}:${{ github.sha }}
```

### 2.5 éƒ¨ç½²Service
éƒ¨ç½²`Service`æ¥è®¿é—®`Pod`ï¼Œè¿™é‡Œä½¿ç”¨`NodePort`ç±»å‹çš„`Service`ï¼Œè¿™ä¸ªç±»å‹å¯ä»¥é€šè¿‡å¯¹`Node` (`Pod`è¿è¡Œåœ¨`Node`ä¸­)çš„ç«¯å£æ¥æ˜ å°„`Pod`æš´éœ²çš„ç«¯å£:  

```yaml
apiVersion: v1
kind: Service
metadata:
  name: client-node-port
spec:
  type: NodePort
  ports:
    - port: 3050
      targetPort: 3000
      nodePort: 31515
  selector:
    component: web

```
ç®€å•è¯´æ˜ä¸‹ï¼Œé¦–å…ˆ`Kind`ç±»å‹æ˜¯`Service`ï¼Œ`spec`å®šä¹‰äº†æš´éœ²çš„ç«¯å£ä»¥åŠå¯¹ä»€ä¹ˆç”Ÿæ•ˆã€‚ 
 
ç«¯å£:
1. 3050ï¼š è¯¥`Service`çš„ç«¯å£
2. 3000: æœ€ç»ˆå°†ç½‘ç»œè½¬å‘åˆ°`Pod`çš„3000ç«¯å£
3. 31515: å¯¹å¤–æš´éœ²çš„`Node`çš„ç«¯å£  

å¤–éƒ¨é€šè¿‡`Nodeçš„ip:31515`æ¥è®¿é—®`Podçš„3000`:  
1. `Nodeçš„31515`æ¥æ”¶åˆ°è¯·æ±‚
2. `Node`è½¬å‘ç»™`Serviceçš„3050`
3. `Service`å†å°†è¯·æ±‚è½¬å‘ç»™`Pod:3000`  

`selector`: å¯¹`metadataçš„componentæ˜¯web`ç”Ÿæ•ˆã€‚

éƒ¨ç½²åŠæŸ¥çœ‹`Service`:  
```bash
hwxy@myubuntu:~/k8s/simplek8s$ kubectl apply -f client-node-port.yaml
service/client-node-port created
hwxy@myubuntu:~/k8s/simplek8s$ kubectl get service
NAME               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
client-node-port   NodePort    10.106.98.219   <none>        3050:31515/TCP   7s
kubernetes         ClusterIP   10.96.0.1       <none>        443/TCP          6d20h
```

### 2.6 æµ‹è¯•è¯·æ±‚
1. è·å–`Node`ip
2ç§åŠæ³•éƒ½è¡Œ
```bash
hwxy@myubuntu:~/k8s/simplek8s$ kubectl get nodes -o wide
NAME       STATUS   ROLES           AGE     VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
minikube   Ready    control-plane   6d20h   v1.26.3   192.168.49.2   <none>        Ubuntu 20.04.5 LTS   5.15.0-76-generic   docker://23.0.2
hwxy@myubuntu:~/k8s/simplek8s$ minikube ip
192.168.49.2
```

2. æµ‹è¯•è¯·æ±‚`Node:31515`  
```bash
hwxy@myubuntu:~/k8s/simplek8s$ curl 192.168.49.2:31515
<!doctype html><html lang="en"><head><meta charset="utf-8"/><link rel="icon" href="/favicon.ico"/><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="theme-color" content="#000000"/><meta name="description" content="Web site created using create-react-app"/><link rel="apple-touch-icon" href="/logo192.png"/><link rel="manifest" href="/manifest.json"/><title>React App</title><script defer="defer" src="/static/js/main.ffb577f0.js"></script><link href="/static/css/main.9def8c4a.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"></div></body></html>hwxy@myubuntu:~/
```

## 3. æ¸…ç†èµ„æº

### 3.1 åˆ é™¤PodåŠService
2ç§æ–¹æ³•éƒ½è¡Œ
```bash
hwxy@myubuntu:~/k8s/simplek8s$ kubectl delete -f client-pod.yaml
pod "client-pod" deleted
hwxy@myubuntu:~/k8s/simplek8s$ kubectl get service
NAME               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
client-node-port   NodePort    10.106.98.219   <none>        3050:31515/TCP   3m32s
kubernetes         ClusterIP   10.96.0.1       <none>        443/TCP          6d20h
hwxy@myubuntu:~/k8s/simplek8s$ kubectl delete service client-node-port
service "client-node-port" deleted
```

### 3.2 åœæ­¢Minikube

```bash
hwxy@myubuntu:~/k8s/simplek8s$ minikube stop
âœ‹  Stopping node "minikube"  ...
ğŸ›‘  Powering off "minikube" via SSH ...
ğŸ›‘  1 node stopped.
```